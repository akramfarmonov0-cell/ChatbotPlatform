{% extends "base.html" %}

{% block title %}Chat - Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>Suhbatlar</h5>
                    <button class="btn btn-sm btn-primary" onclick="startNewConversation()">
                        <i class="fas fa-plus"></i> Yangi Suhbat
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="conversationsList">
                        {% for conv in conversations %}
                        <a href="#" class="list-group-item list-group-item-action conversation-item" 
                           data-conversation-id="{{ conv.id }}">
                            <div class="d-flex justify-content-between">
                                <strong>{{ conv.title[:30] }}{% if conv.title|length > 30 %}...{% endif %}</strong>
                                <small class="text-muted">{{ conv.updated_at.strftime('%H:%M') }}</small>
                            </div>
                            <small class="text-muted">{{ conv.platform_type or 'Web' }}</small>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-9">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">AI Chat</h5>
                    <div>
                        <span class="badge bg-success" id="connectionStatus">Online</span>
                    </div>
                </div>
                
                <div class="card-body d-flex flex-column" style="height: 500px;">
                    <div class="flex-grow-1 overflow-auto" id="messagesContainer">
                        <div class="text-center text-muted mt-4">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <p>Suhbatni boshlash uchun xabar yozing...</p>
                        </div>
                    </div>
                    
                    <div class="border-top pt-3 mt-3">
                        <form id="chatForm" class="d-flex">
                            <input type="text" class="form-control" id="messageInput" 
                                   placeholder="Xabaringizni yozing..." autocomplete="off">
                            <button type="submit" class="btn btn-primary ms-2">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentConversationId = null;

function startNewConversation() {
    currentConversationId = null;
    document.getElementById('messagesContainer').innerHTML = `
        <div class="text-center text-muted mt-4">
            <i class="fas fa-comments fa-3x mb-3"></i>
            <p>Yangi suhbat boshlandi. Xabar yozing...</p>
        </div>
    `;
}

document.getElementById('chatForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    addMessageToChat('user', message);
    messageInput.value = '';
    
    try {
        const response = await fetch('/dashboard/api/chat/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                conversation_id: currentConversationId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentConversationId = data.conversation_id;
            addMessageToChat('assistant', data.response);
        } else {
            addMessageToChat('error', data.error || 'Xato yuz berdi');
        }
    } catch (error) {
        addMessageToChat('error', 'Server bilan aloqa xatosi');
    }
});

function addMessageToChat(role, content) {
    const container = document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-3 ${role === 'user' ? 'text-end' : 'text-start'}`;
    
    const badge = role === 'user' ? 'bg-primary' : 
                  role === 'error' ? 'bg-danger' : 'bg-secondary';
    
    messageDiv.innerHTML = `
        <div class="d-inline-block p-2 rounded ${badge} text-white" style="max-width: 70%;">
            ${content}
        </div>
        <div class="small text-muted mt-1">
            ${new Date().toLocaleTimeString()}
        </div>
    `;
    
    // Clear welcome message if exists
    if (container.querySelector('.text-center')) {
        container.innerHTML = '';
    }
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}
</script>
{% endblock %}